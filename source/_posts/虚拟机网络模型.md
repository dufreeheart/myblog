---
title: 虚拟机网络模型
date: 2019-08-25 18:38:45
categories: 
    - 虚拟机
tags: 
    - 虚拟机
    - 网络模型
---

## 1 ）基础知识

今天恶补了一下网络相关的知识，由于为了了解 docker 的网络模型，发现自己虚拟机的网络模型也不是很清楚，然后去了解虚拟机的网络模式时，发现基本的 Linux 的网络模式不是很清了，然后过程中有很多自己以前了解过的知识点现在想用的时候发现都不太记得了。所以就已开始把基础的知识点快速的过了下，太细节的就不记录了，把重点的几个点简单的记一下。

**NAT**

NAT是 Network Address Translation 网络地址转换的缩写。

NAT是将私有IP地址通过边界路由转换成外网IP地址，在边界路由的NAT地址转换表记录下这个转换映射记录，当外部数据返回时，路由使用NAT技术查询NAT转换表，再将目标地址替换成内网用户IP地址。 

至于为什会出现 NAT 技术，其实总结起来就一句话，IP 地址不够用了。其实还可以能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机。

简单介绍几种 NAT：

1. 静态 NAT

   静态NAT就是一对一映射，内部有多少私有地址需要和外部通信，就要配置多少外网IP地址与其对应，并不节省外网IP，所以一般不用

   ![image-20190726233617169](http://ww3.sinaimg.cn/large/006tNc79gy1g5dnzdgqngj31r20gktcs.jpg)

2. 动态 NAT 

   动态NAT是在路由器上配置一个外网IP地址池，当内部有计算机需要和外部通信时，就从地址池里动态的取出一个外网IP，并将他们的对应关系绑定到NAT表中，通信结束后，这个外网IP才被释放，可供其他内部IP地址转换使用，这个DHCP租约IP有相似之处。

   ![image-20190726233947623](http://ww1.sinaimg.cn/large/006tNc79gy1g5do2yn57pj31r60g6q7e.jpg)

3. PAT(port address Translation，端口地址转换，也叫端口地址复用)

   这是最常用的NAT技术，也是IPv4能够维持到今天的最重要的原因之一，它提供了一种多对一的方式，对多个内网IP地址，边界路由可以给他们分配一个外网IP，利用这个外网IP的不同端口和外部进行通信。

   ![image-20190726234201119](http://ww4.sinaimg.cn/large/006tNc79gy1g5do5e39efj31qw0fywik.jpg)

**veth**

- veth和其它的网络设备都一样，一端连接的是内核协议栈。
- veth设备是成对出现的，另一端两个设备彼此相连
- 一个设备收到协议栈的数据发送请求后，会将数据发送到另一个设备上去。

## 2 ）虚拟机的三种网络模式

**桥接**

桥接网络是指本地物理网卡和虚拟网卡通过VMnet0虚拟交换机进行桥接，物理网卡和虚拟网卡在拓扑图上处于同等地位，那么物理网卡和虚拟网卡就相当于处于同一个网段，虚拟交换机就相当于一台现实网络中的交换机,所以两个网卡的IP地址也要设置为同一网段。

其实说白了，桥接模式下，可以看成虚拟机和物理机同是一台交换机上的几个主机。

![image-20190726235720901](http://ww2.sinaimg.cn/large/006tNc79ly1g5dol8wm1pj30my0koabc.jpg)

**NAT**

NAT模式中，就是让虚拟机借助NAT(网络地址转换)功能，通过宿主机器所在的网络来访问公网。

NAT模式中，虚拟机的网卡和物理网卡的网络，不在同一个网络，虚拟机的网卡，是在vmware提供的一个虚拟网络。

其实感觉虚拟机的NAT就有点相当于内网和外网之间的NAT，图参考上一个NAT知识点就OK了。

NAT和桥接的比较:

1. NAT模式和桥接模式虚拟机都可以上外网。
2. 由于NAT的网络在vmware提供的一个虚拟网络里，所以局域网其他主机是无法访问虚拟机的，而宿主机可以访问虚拟机，虚拟机可以访问局域网的所有主机，因为真实的局域网相对于NAT的虚拟网络，就是NAT的虚拟网络的外网，不懂的人可以查查NAT的相关知识。
3. 桥接模式下，多个虚拟机之间可以互相访问；NAT模式下，多个虚拟机之间也可以相互访问。

**Host-Only**

在Host-Only模式下，虚拟网络是一个全封闭的网络，它唯一能够访问的就是主机。其实Host-Only网络和NAT网络很相似，不同的地方就是Host-Only网络没有NAT服务，所以虚拟网络不能连接到Internet。主机和虚拟机之间的通信是通过VMware Network Adepter VMnet1虚拟网卡来实现的。

Host-Only的宗旨就是建立一个与外界隔绝的内部网络，来提高内网的安全性。这个功能或许对普通用户来说没有多大意义，但大型服务商会常常利用这个功能。如果你想为VMnet1网段提供路由功能，那就需要使用RRAS，而不能使用XP或2000的ICS，因为ICS会把内网的IP地址改为192.168.0.1，但虚拟机是不会给VMnet1虚拟网卡分配这个地址的，那么主机和虚拟机之间就不能通信了。